<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê≥ïÂæãÊ≥ïËßÑ‰∏éÊ°à‰æãÂ∫ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(255, 255, 255, 0.8);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --highlight-bg: #fef3c7;
            /* Yellowish */
            --highlight-text: #d97706;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .navbar-brand,
        .nav-link {
            color: var(--text-primary) !important;
            font-weight: 600;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
        }

        .card-item {
            display: block;
            text-decoration: none;
            color: inherit;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.95);
            color: inherit;
        }

        .badge-law {
            background-color: #3b82f6;
        }

        .badge-case {
            background-color: #10b981;
        }

        .search-highlight {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Mobile Adaptation */
        @media (max-width: 768px) {
            .navbar-nav .btn-primary {
                display: none !important;
                /* Hide Add button on mobile */
            }

            .search-box {
                padding: 15px;
                /* Reduce padding */
                margin-top: 15px;
            }

            .card-item {
                padding: 15px;
                /* Compact cards */
            }

            .navbar {
                padding: 0.5rem 1rem;
            }

            /* Stack filters with gaps */
            .search-box .row [class^="col-"] {
                margin-bottom: 10px;
            }

            .badge {
                font-size: 0.7rem !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-home"></i> Smarter Tools</a>
            <div class="navbar-nav ms-auto">
                <a href="/anli/edit" class="btn btn-primary btn-sm rounded-pill px-4"><i class="fas fa-plus"></i>
                    Êñ∞Â¢ûÊù°ÁõÆ</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Search & Filter -->
        <div class="search-box">
            <h4 class="mb-4 text-center fw-bold text-secondary">Ê≥ïÂæãÊ≥ïËßÑ‰∏éÊ°à‰æãÂ∫ì</h4>
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="ÊêúÁ¥¢‰∏ªÈ¢ò„ÄÅÂÜÖÂÆπÊàñÂÖ≥ÈîÆËØç..." style="font-size: 1rem;">
                    </div>
                </div>
                <div class="col-md-3">
                    <!-- Multi-Select Dropdown for Tags -->
                    <div class="dropdown w-100">
                        <button
                            class="btn btn-lg btn-outline-secondary w-100 dropdown-toggle text-start d-flex justify-content-between align-items-center bg-white"
                            type="button" id="tagFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            data-bs-auto-close="outside">
                            <span id="selectedTagsLabel" class="text-truncate">ÈÄâÊã©Ê†áÁ≠æ</span>
                        </button>
                        <ul class="dropdown-menu w-100 p-2" id="tagDropdownMenu"
                            style="max-height: 300px; overflow-y: auto;">
                            <li>
                                <div class="px-2 pb-2">
                                    <input type="text" class="form-control form-control-sm" id="tagDropdownSearch"
                                        placeholder="üîç Ê£ÄÁ¥¢Ê†áÁ≠æ..." oninput="filterDropdownTags(this.value)"
                                        onclick="event.stopPropagation()">
                                </div>
                            </li>
                            <li>
                                <h6 class="dropdown-header">ÂèØÁî®Ê†áÁ≠æ (Â§öÈÄâ)</h6>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <!-- Tags loaded here -->
                            <div id="dropdownTagList">
                                <li class="text-center text-muted small py-2">Âä†ËΩΩ‰∏≠...</li>
                            </div>
                        </ul>
                    </div>
                </div>
                <div class="col-md-2">
                    <select id="typeFilter" class="form-select form-select-lg">
                        <option value="">ÊâÄÊúâÁ±ªÂûã</option>
                        <option value="Ê≥ïÂæãÊ≥ïËßÑ" selected>Ê≥ïÂæãÊ≥ïËßÑ</option>
                        <option value="Ê°à‰æã">Ê°à‰æã</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-lg w-100" onclick="loadData()">Êêú Á¥¢</button>
                </div>
            </div>
            <div class="mt-2" id="selectedTagsContainer">
                <!-- Selected badges show here -->
            </div>
        </div>

        <!-- List -->
        <div id="resultsList">
            <div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mb-5">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentQuery = '';
        let selectedTags = new Set();
        let allTags = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadTagsDropdown();
            loadData();

            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') loadData();
            });
        });

        async function loadTagsDropdown() {
            try {
                const resp = await fetch('/anli/api/tags');
                allTags = await resp.json();
                renderTagDropdown();
            } catch (e) {
                console.error("Tags load failed", e);
            }
        }

        function renderTagDropdown() {
            filterDropdownTags('');
        }

        function filterDropdownTags(query) {
            const container = document.getElementById('dropdownTagList');
            container.innerHTML = '';

            const q = query.toLowerCase();
            const filtered = allTags.filter(t => t.toLowerCase().includes(q));

            if (filtered.length === 0) {
                container.innerHTML = '<li class="text-center text-muted small py-2">Êó†ÂåπÈÖçÊ†áÁ≠æ</li>';
                return;
            }

            filtered.forEach((tag) => {
                const idx = allTags.indexOf(tag);
                const isChecked = selectedTags.has(tag);

                const li = document.createElement('li');
                li.className = 'dropdown-item p-0 mb-1 rounded';
                li.onclick = (e) => e.stopPropagation();

                const div = document.createElement('div');
                div.className = 'form-check m-2 position-relative'; // Add position-relative to contain stretched-link

                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.value = tag;
                input.id = `cb_tag_${idx}`;
                if (isChecked) input.checked = true;

                input.onchange = () => toggleTag(tag);

                const label = document.createElement('label');
                label.className = 'form-check-label w-100 stretched-link';
                label.htmlFor = `cb_tag_${idx}`;
                label.innerText = tag;

                div.appendChild(input);
                div.appendChild(label);
                li.appendChild(div);
                container.appendChild(li);
            });
        }

        function toggleTag(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            updateSelectedUI();
        }

        function updateSelectedUI() {
            const label = document.getElementById('selectedTagsLabel');
            const container = document.getElementById('selectedTagsContainer');

            if (selectedTags.size === 0) {
                label.innerText = 'ÈÄâÊã©Ê†áÁ≠æ';
                label.classList.remove('fw-bold', 'text-primary');
                container.innerHTML = '';
            } else {
                label.innerText = `Â∑≤ÈÄâ ${selectedTags.size} ‰∏™Ê†áÁ≠æ`;
                label.classList.add('fw-bold', 'text-primary');

                // Show pills below
                let html = '';
                selectedTags.forEach(t => {
                    html += `<span class="badge bg-primary me-2 mb-2 p-2">
                                ${t} <i class="fas fa-times ms-1 cursor-pointer" onclick="removeTag('${t}')" style="cursor:pointer"></i>
                            </span>`;
                });
                container.innerHTML = html;
            }
        }

        function removeTag(tag) {
            // Uncheck box
            const idx = allTags.indexOf(tag);
            if (idx > -1) {
                const cb = document.getElementById(`cb_tag_${idx}`);
                if (cb) cb.checked = false;
            }
            toggleTag(tag);
            // Optionally reload data immediately? User might expect "Search" button click first.
            // Let's stick to manual search button trigger based on UI layout.
        }

        function highlightText(text, query, tokens = []) {
            if (!text) return text;

            // Prefer tokens from backend (Jieba) if available
            let terms = [];
            if (tokens && tokens.length > 0) {
                terms = tokens;
            } else if (query) {
                // Fallback to simple split
                terms = query.split(/\s+/).filter(t => t.length > 0);
            }

            if (terms.length === 0) return text;

            try {
                const safeTerms = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                // Sort by length desc to match longer terms first (e.g. "Review Standard" before "Review")
                safeTerms.sort((a, b) => b.length - a.length);

                const pattern = new RegExp(`(${safeTerms.join('|')})`, 'gi');
                return text.replace(pattern, '<span class="search-highlight">$1</span>');
            } catch (e) {
                return text;
            }
        }

        async function loadData(page = 1) {
            currentPage = page;
            const q = document.getElementById('searchInput').value;
            currentQuery = q;
            const type = document.getElementById('typeFilter').value;

            // Join tags by comma
            const tagStr = Array.from(selectedTags).join(',');

            let url = `/anli/api/list?page=${page}&q=${encodeURIComponent(q)}&type=${encodeURIComponent(type)}&t=${new Date().getTime()}`;
            if (tagStr) url += `&tag=${encodeURIComponent(tagStr)}`;

            const listContainer = document.getElementById('resultsList');
            listContainer.style.opacity = '0.5';

            try {
                const resp = await fetch(url);
                const data = await resp.json();

                listContainer.style.opacity = '1';
                listContainer.innerHTML = '';

                if (data.data.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-5 text-muted">ÊöÇÊó†Á¨¶ÂêàÊù°‰ª∂ÁöÑÊï∞ÊçÆ</div>';
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                data.data.forEach(item => {
                    let tagsHtml = '';
                    try {
                        const tags = JSON.parse(item.tags || '[]');
                        tags.forEach(t => tagsHtml += `<span class="badge bg-light text-dark me-1 border">${t}</span>`);
                    } catch (e) { }

                    const badgeClass = item.type === 'Ê≥ïÂæãÊ≥ïËßÑ' ? 'badge-law' : 'badge-case';
                    const titleHtml = highlightText(item.title, currentQuery, data.search_terms);
                    const summaryHtml = highlightText(item.summary, currentQuery, data.search_terms);

                    const detailUrl = currentQuery ? `/anli/view/${item.uuid}?q=${encodeURIComponent(currentQuery)}` : `/anli/view/${item.uuid}`;

                    const docNumHtml = item.doc_number ? `<span class="badge bg-secondary ms-2 align-middle" style="font-size: 0.75rem;">${highlightText(item.doc_number, currentQuery, data.search_terms)}</span>` : '';

                    const html = `
                    <a href="${detailUrl}" class="card-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <h6 class="mb-0 fw-bold text-dark d-inline align-middle" style="font-size: 1.1rem;">${titleHtml}</h6>
                                ${docNumHtml}
                            </div>
                            <span class="badge ${badgeClass} rounded-pill" style="font-size: 0.75rem;">${item.type}</span>
                        </div>
                        <p class="text-secondary small mb-2" style="font-size: 0.9rem; line-height: 1.5;">${summaryHtml}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>${tagsHtml}</div>
                            <small class="text-muted" style="font-size: 0.8rem;"><i class="far fa-clock"></i> ${item.created_at.split(' ')[0]}</small>
                        </div>
                    </a>`;

                    listContainer.innerHTML += html;
                });

                const totalPages = Math.ceil(data.total / data.per_page);
                let pageHtml = '';
                if (currentPage > 1) {
                    pageHtml += `<li class="page-item"><button class="page-link" onclick="loadData(${currentPage - 1})">‰∏ä‰∏ÄÈ°µ</button></li>`;
                }
                pageHtml += `<li class="page-item disabled"><span class="page-link"> ${currentPage} / ${totalPages} </span></li>`;
                if (currentPage < totalPages) {
                    pageHtml += `<li class="page-item"><button class="page-link" onclick="loadData(${currentPage + 1})">‰∏ã‰∏ÄÈ°µ</button></li>`;
                }
                document.getElementById('pagination').innerHTML = pageHtml;

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="alert alert-danger">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
            }
        }
    </script>
</body>

</html>