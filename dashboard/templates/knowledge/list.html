<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(255, 255, 255, 0.8);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --highlight-bg: #fef3c7;
            /* Yellowish */
            --highlight-text: #d97706;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .navbar-brand,
        .nav-link {
            color: var(--text-primary) !important;
            font-weight: 600;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
            position: relative;
            z-index: 100;
        }

        /* Enforce equal height for all search inputs/buttons */
        .search-box .form-control,
        .search-box .input-group-text,
        .search-box .btn-lg,
        .search-box .form-select-lg,
        .search-box .dropdown-toggle {
            height: 50px;
            font-size: 1rem;
        }

        .search-box .input-group-text i {
            line-height: 1;
        }

        .search-box .dropdown-toggle {
            display: flex;
            align-items: center;
        }

        .card-item {
            display: block;
            text-decoration: none;
            color: inherit;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.95);
            color: inherit;
        }

        .badge-law {
            background-color: #3b82f6;
        }

        .badge-case {
            background-color: #10b981;
        }

        .search-highlight {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }

        .tag-badge {
            background-color: #eef2ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
            font-weight: 500;
            transition: all 0.2s;
        }

        .card-item:hover .tag-badge {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
        }

        /* Mobile Adaptation */
        @media (max-width: 768px) {
            .navbar-nav .btn-primary {
                display: none !important;
                /* Hide Add button on mobile */
            }

            .search-box {
                padding: 15px;
                /* Reduce padding */
                margin-top: 15px;
            }

            .card-item {
                padding: 15px;
                /* Compact cards */
            }

            .navbar {
                padding: 0.5rem 1rem;
            }

            /* Stack filters with gaps */
            .search-box .row [class^="col-"] {
                margin-bottom: 10px;
            }

            .badge {
                font-size: 0.7rem !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-home"></i> Smarter Tools</a>
            <div class="navbar-nav ms-auto">
                <a href="/zhishi/edit" class="btn btn-primary btn-sm rounded-pill px-4"><i class="fas fa-plus"></i>
                    æ–°å¢æ¡ç›®</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Search & Filter -->
        <div class="search-box">
            <h4 class="mb-4 text-center fw-bold text-secondary">æ³•å¾‹æ³•è§„ä¸çŸ¥è¯†åº“</h4>
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="æœç´¢ä¸»é¢˜ã€å†…å®¹æˆ–å…³é”®è¯..." style="font-size: 1rem;">
                    </div>
                </div>
                <div class="col-md-3">
                    <!-- Tag Filter Button -->
                    <button
                        class="btn btn-lg btn-outline-secondary w-100 d-flex justify-content-between align-items-center bg-white"
                        onclick="openFilterTagModal()">
                        <span id="tagFilterButtonLabel">é€‰æ‹©æ ‡ç­¾</span>
                        <i class="fas fa-tags text-muted"></i>
                    </button>
                </div>
                <div class="col-md-2">
                    <select id="typeFilter" class="form-select form-select-lg">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="æ³•å¾‹æ³•è§„" selected>æ³•å¾‹æ³•è§„</option>
                        <option value="æ¡ˆä¾‹">çŸ¥è¯†åº“</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-lg w-100" onclick="loadData()">æœ ç´¢</button>
                </div>
            </div>
            <div class="mt-2" id="selectedTagsContainer">
                <!-- Selected badges show here -->
            </div>
        </div>

        <!-- List -->
        <div id="resultsList">
            <div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mb-5">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>

    <!-- Filter Tags Modal -->
    <div class="modal fade" id="filterTagModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">ç­›é€‰æ ‡ç­¾</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="filterTagSearchInput" placeholder="ğŸ” æœç´¢æ ‡ç­¾..."
                            oninput="renderFilterModalTags()">
                    </div>
                    <div id="filterTagList" class="d-flex flex-wrap gap-2"
                        style="max-height: 400px; overflow-y: auto; padding: 5px;">
                        <!-- Tags rendered here -->
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <div class="me-auto text-muted small" id="tagSelectionCount">å·²é€‰ 0 ä¸ª</div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary px-4" onclick="confirmFilterTags()">ç¡®å®šç­›é€‰</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentQuery = '';
        let selectedTags = new Set();
        let allTags = [];
        let tempSelectedTags = new Set(); // For Modal state

        document.addEventListener('DOMContentLoaded', () => {
            fetchTags(); // Load tags initially
            loadData();

            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') loadData();
            });
        });

        // --- Tag Logic ---
        async function fetchTags() {
            try {
                const resp = await fetch(`/zhishi/api/tags?t=${new Date().getTime()}`);
                allTags = await resp.json();
            } catch (e) {
                console.error("Failed to load tags", e);
            }
        }

        async function openFilterTagModal() {
            // Fetch fresh tags
            await fetchTags();

            // Copy current selection to temp
            tempSelectedTags = new Set(selectedTags);

            // Clear search
            document.getElementById('filterTagSearchInput').value = '';

            // Render
            renderFilterModalTags();

            // Show Modal
            new bootstrap.Modal(document.getElementById('filterTagModal')).show();
        }

        function renderFilterModalTags() {
            const container = document.getElementById('filterTagList');
            const search = document.getElementById('filterTagSearchInput').value.toLowerCase();

            container.innerHTML = '';

            const filtered = allTags.filter(t => t.toLowerCase().includes(search));

            if (filtered.length === 0) {
                container.innerHTML = '<div class="w-100 text-center text-muted py-4">æœªæ‰¾åˆ°åŒ¹é…æ ‡ç­¾</div>';
                return;
            }

            filtered.forEach(tag => {
                const isSelected = tempSelectedTags.has(tag);
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${isSelected ? 'btn-primary' : 'btn-outline-secondary'} rounded-pill px-3`;
                btn.textContent = tag;
                btn.onclick = () => toggleModalTag(tag);
                container.appendChild(btn);
            });

            updateModalCount();
        }

        function toggleModalTag(tag) {
            if (tempSelectedTags.has(tag)) {
                tempSelectedTags.delete(tag);
            } else {
                tempSelectedTags.add(tag);
            }
            renderFilterModalTags();
        }

        function updateModalCount() {
            document.getElementById('tagSelectionCount').textContent = `å·²é€‰ ${tempSelectedTags.size} ä¸ª`;
        }

        function confirmFilterTags() {
            // Commit changes
            selectedTags = new Set(tempSelectedTags);

            // Update UI Button Label
            const btnLabel = document.getElementById('tagFilterButtonLabel');
            if (selectedTags.size > 0) {
                btnLabel.textContent = `å·²é€‰ ${selectedTags.size} ä¸ªæ ‡ç­¾`;
                btnLabel.classList.add('text-primary', 'fw-bold');
            } else {
                btnLabel.textContent = 'é€‰æ‹©æ ‡ç­¾';
                btnLabel.classList.remove('text-primary', 'fw-bold');
            }

            // Update Selected Container (Below Search Box)
            renderSelectedTagsBadge();

            // Close Modal
            bootstrap.Modal.getInstance(document.getElementById('filterTagModal')).hide();

            // Reload Data
            loadData();
        }

        function renderSelectedTagsBadge() {
            const container = document.getElementById('selectedTagsContainer');
            container.innerHTML = '';

            if (selectedTags.size === 0) return;

            const badgeContainer = document.createElement('div');
            badgeContainer.className = 'd-flex flex-wrap gap-2 align-items-center';
            badgeContainer.innerHTML = '<span class="text-muted small me-1">ç­›é€‰æ¡ä»¶:</span>';

            selectedTags.forEach(tag => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary rounded-pill d-flex align-items-center gap-1 ps-3 pe-2 py-2';
                badge.innerHTML = `
                    ${tag}
                    <i class="fas fa-times-circle" style="cursor:pointer; opacity:0.8;" 
                       onclick="removeTag('${tag}')"></i>
                `;
                badgeContainer.appendChild(badge);
            });

            // Clear all button
            if (selectedTags.size > 1) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-link btn-sm text-decoration-none text-muted p-0 ms-2';
                clearBtn.textContent = 'æ¸…ç©º';
                clearBtn.onclick = clearAllTags;
                badgeContainer.appendChild(clearBtn);
            }

            container.appendChild(badgeContainer);
        }

        function removeTag(tag) {
            selectedTags.delete(tag);
            renderSelectedTagsBadge();

            // Update Button Label
            const btnLabel = document.getElementById('tagFilterButtonLabel');
            if (selectedTags.size > 0) {
                btnLabel.textContent = `å·²é€‰ ${selectedTags.size} ä¸ªæ ‡ç­¾`;
            } else {
                btnLabel.textContent = 'é€‰æ‹©æ ‡ç­¾';
                btnLabel.classList.remove('text-primary', 'fw-bold');
            }

            loadData();
        }

        function clearAllTags() {
            selectedTags.clear();
            renderSelectedTagsBadge();
            document.getElementById('tagFilterButtonLabel').textContent = 'é€‰æ‹©æ ‡ç­¾';
            document.getElementById('tagFilterButtonLabel').classList.remove('text-primary', 'fw-bold');
            loadData();
        }

        // --- Data Loading ---
        async function loadData(page = 1) {
            currentPage = page;
            const query = document.getElementById('searchInput').value.trim();
            const type = document.getElementById('typeFilter').value;
            const container = document.getElementById('resultsList');

            // Tags
            const tags = Array.from(selectedTags).join(',');

            container.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>';

            try {
                // Construct URL
                let url = `/zhishi/api/list?page=${page}&q=${encodeURIComponent(query)}&type=${encodeURIComponent(type)}`;
                if (tags) url += `&tag=${encodeURIComponent(tags)}`;

                const resp = await fetch(url);
                const data = await resp.json();

                renderList(data.data, data.search_terms);
                renderPagination(data);

                // Highlight active tags in badges if any
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-center py-5 text-danger">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderList(items, keywords) {
            const container = document.getElementById('resultsList');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">æš‚æ— ç›¸å…³æ•°æ®</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                let badgeClass = 'bg-secondary';
                if (item.type === 'æ³•å¾‹æ³•è§„') badgeClass = 'badge-law';
                if (item.type === 'æ¡ˆä¾‹') badgeClass = 'badge-case';

                // Format Tags
                let tagsHtml = '';
                if (item.tags) {
                    try {
                        const tList = JSON.parse(item.tags);
                        // Use tag-badge class for purple style
                        tagsHtml = tList.map(t => `<span class="badge tag-badge rounded-pill me-1">${t}</span>`).join('');
                    } catch (e) { }
                }

                // Date Logic: Publish Date > Created At
                // created_at format might be 'YYYY-MM-DD HH:MM:SS', assume we just want Date? 
                // User said "show entry time" if no publish date. Format as is or substring?
                // Let's keep it simple first.
                let displayDate = item.publish_date;
                if (!displayDate && item.created_at) {
                    displayDate = item.created_at.split(' ')[0]; // Just date part usually preferred
                }

                html += `
                <a href="/zhishi/view/${item.uuid}" class="card-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold mb-0 text-dark flex-grow-1 me-2">${highlightText(item.title, keywords)}</h5>
                        <span class="badge ${badgeClass} rounded-pill px-3 py-2 text-nowrap">${item.type === 'æ¡ˆä¾‹' ? 'çŸ¥è¯†åº“' : item.type}</span>
                    </div>
                    <p class="text-secondary mb-3 text-truncate-3" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                        ${highlightText(item.summary || '', keywords)}
                    </p>
                    <div class="d-flex justify-content-between align-items-end mt-auto">
                        <div class="d-flex align-items-center flex-wrap">
                           ${tagsHtml}
                        </div>
                        <small class="text-muted text-nowrap ms-2">${displayDate || ''}</small>
                    </div>
                </a>
                `;
            });
            container.innerHTML = html;
        }

        function highlightText(text, keywords) {
            if (!keywords || keywords.length === 0) return text;
            let res = text;
            keywords.forEach(k => {
                if (k) res = res.replace(new RegExp(k, 'gi'), `<span class="search-highlight">$&</span>`);
            });
            return res;
        }

        function renderPagination(data) {
            const container = document.getElementById('pagination');
            let html = '';

            const totalPages = Math.ceil(data.total / data.per_page);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            // Prev
            html += `<li class="page-item ${data.page === 1 ? 'disabled' : ''}">
                        <button class="page-link" onclick="loadData(${data.page - 1})">ä¸Šä¸€é¡µ</button>
                    </li>`;

            // Simple Pagination: 1 ... current ... last
            // For now just show all or simple range? Let's show simple range.
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= data.page - 2 && i <= data.page + 2)) {
                    html += `<li class="page-item ${i === data.page ? 'active' : ''}">
                                <button class="page-link" onclick="loadData(${i})">${i}</button>
                            </li>`;
                } else if (i === data.page - 3 || i === data.page + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next
            html += `<li class="page-item ${data.page === totalPages ? 'disabled' : ''}">
                        <button class="page-link" onclick="loadData(${data.page + 1})">ä¸‹ä¸€é¡µ</button>
                    </li>`;

            container.innerHTML = html;
        }
    </script>
</body>

</html>